#!/bin/bash
set -uo pipefail
shopt -s extglob
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR
IFS=$'\n\t'

# Source for this script:
# https://github.com/kr15h/travis-raspbian-image
# https://disconnected.systems/blog/custom-rpi-image-with-github-travis/

pynab_repository=${GITHUB_REPOSITORY:-nabaztag2018/pynab}
pynab_branch=${GITHUB_BRANCH:-release}
case ${pynab_branch} in
    v+([0-9]).+([0-9]).+([0-9])*)
	# vX.Y.Z tag-driven build: assume release branch
	pynab_tag=" (tag ${pynab_branch})"
	pynab_branch=release
	;;
    *)
	# sssume branch-driven build on given branch
	pynab_tag=""
	;;
esac
echo "Doing setup for ${pynab_repository} ${pynab_branch} branch${pynab_tag}."

GPU_MEM=16
LC_ALL=C

install_env="ci-chroot"
if [ "${1:-}" == "--local" ]
then
    # Local setup: allows doing initial or replacing existing setup on Pi Zero.
    install_env=""
    if [ "$(id -u)" != "0" ]
    then
	echo "$(basename ${0}) ${1} must be run as root."
	echo "WARNING: Removes any existing Pynab setup."
	exit 1
    fi
    cd /home/pi
    rm -rf /home/pi/pynab /home/pi/wm8960 /home/pi/tagtagtag-ears /home/pi/cr14
fi

# Replace /boot/cmdline.txt since it contains root device mapping to a PARTUUID that 
# changed during parted resize.
echo "Replacing /boot/cmdline.txt."
echo "dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait quiet init=/usr/lib/raspi-config/init_resize.sh" > "/boot/cmdline.txt"
cat "/boot/cmdline.txt"

# Resize partition on first boot.
# https://www.raspberrypi.org/forums/viewtopic.php?p=1503766#p1503766
wget -O /etc/init.d/resize2fs_once https://raw.githubusercontent.com/RPi-Distro/pi-gen/master/stage2/01-sys-tweaks/files/resize2fs_once
chmod +x /etc/init.d/resize2fs_once
systemctl enable resize2fs_once

# Replace /etc/fstab since the non existing PARTUUID has to be changed here as well.
echo "Replacing /etc/fstab."
echo "proc            /proc           proc    defaults          0       0" > "/etc/fstab"
echo "/dev/mmcblk0p1  /boot           vfat    defaults          0       2" >> "/etc/fstab"
echo "/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1" >> "/etc/fstab"
cat "/etc/fstab"

echo "Setting gpu_mem."
if grep -q "gpu_mem" /boot/config.txt
then
    sed -i "s/gpu_mem.*/gpu_mem=${GPU_MEM}/" /boot/config.txt
else
    echo "gpu_mem=${GPU_MEM}" >> /boot/config.txt
fi
cat /boot/config.txt | grep "gpu_mem"

echo "Setting hostname."
sed -i "s/raspberrypi/nabaztag/" /etc/hostname
sed -i "s/raspberrypi/nabaztag/" /etc/hosts

echo "Setting timezone."
echo "Europe/Paris" > /etc/timezone
ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime

echo "Disabling onboard sound."
if grep -q "^dtparam=audio=on" /boot/config.txt
then
    sed -i "s/dtparam=audio=on/#dtparam=audio=on/" /boot/config.txt
fi
cat /boot/config.txt | grep "dtparam=audio=on"

echo "Enabling DAC for Maker Faire 2018 cards."
if ! grep -q "^dtoverlay=hifiberry-dac" /boot/config.txt
then
    echo "dtoverlay=hifiberry-dac" >> /boot/config.txt
fi
cat /boot/config.txt | grep "dtoverlay=hifiberry-dac"

echo "Installing required packages."
sudo apt-get update -y
sudo apt-get dist-upgrade -y
sudo apt-get install --no-install-recommends -y postgresql libpq-dev git python3 python3-venv python3-dev gettext nginx openssl libssl-dev libffi-dev libmpg123-dev libasound2-dev libatlas-base-dev libgfortran3 libopenblas-dev liblapack-dev zram-tools
sudo apt-get install --no-install-recommends raspberrypi-kernel-headers

echo "Installing sound driver for Ulule 2019 cards."
cd /home/pi
sudo -u pi git clone --depth 1 -b tagtagtag-sound https://github.com/pguyot/wm8960
cd /home/pi/wm8960
make
sudo make install
make clean

echo "Installing ears driver."
cd /home/pi
sudo -u pi git clone --depth 1 https://github.com/pguyot/tagtagtag-ears
cd /home/pi/tagtagtag-ears
make
sudo make install
make clean

echo "Installing RFID reader driver."
cd /home/pi
sudo -u pi git clone --depth 1 https://github.com/pguyot/cr14
cd /home/pi/cr14
make
sudo make install
make clean

echo "Cloning Pynab ${pynab_branch} branch from ${pynab_repository}."
cd /home/pi
sudo -u pi git clone --depth 1 -b ${pynab_branch} https://github.com/${pynab_repository}.git

echo "Installing NabBlockly."
sudo apt-get install --no-install-recommends -y erlang-base erlang-dev erlang-inets erlang-tools erlang-xmerl
cd /home/pi/pynab
sudo -u pi git clone --depth 1 https://github.com/pguyot/nabblockly
cd nabblockly
# Until we can get OTP 24 from Raspian or Erlang Solutions, get an older rebar binary
sudo -u pi wget https://github.com/erlang/rebar3/releases/download/3.15.1/rebar3 && chmod +x rebar3
sudo -u pi ./rebar3 release

echo "Running Pynab install script."
cd /home/pi/pynab
sudo -u pi /bin/bash install.sh ${install_env}

echo "Cleaning up."
# Cleanup any leftovers (from Kaldi install).
sudo find / -xdev -name "._*" -exec rm {} \;
sudo find / -xdev -user 501 -exec chown -h root:root {} \;
# Cleanup caches.
sudo rm -rf /root/.cache /root/.local /root/.wget-hsts
sudo rm -rf /home/pi/.cache /home/pi/.local /home/pi/.wget-hsts

echo "Pynab setup done."
